#!/usr/bin/env bash
#MISE description="Start dev server with Vite (watch + HMR)"
#MISE depends=["setup", "setup-vault", "symlink"]

set -euo pipefail

# Read vault path
VAULT_PATH=$(cat .notes/VAULT_PATH)
PLUGIN_ID=$(grep '"id"' manifest.json | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
HOTRELOAD_PATH="$VAULT_PATH/.obsidian/plugins/$PLUGIN_ID/.hotreload"

# Run Vite in dev mode with watch and trigger .hotreload on changes
vite build --watch --mode development 2>&1 | while IFS= read -r line; do
  echo "$line"
  
  # After each successful build, touch .hotreload to signal Obsidian
  if [[ "$line" == *"built in"* ]]; then
    touch "$HOTRELOAD_PATH" 2>/dev/null && echo "âœ“ Triggered Obsidian reload"
  fi
done
