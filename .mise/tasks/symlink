#!/usr/bin/env bash
# mise description: Symlink plugin to Obsidian vault

set -euo pipefail

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
VAULT_PATH_FILE="$PROJECT_DIR/.notes/VAULT_PATH"

# Check if vault path is configured
if [ ! -f "$VAULT_PATH_FILE" ]; then
    echo "❌ Vault path not configured. Run 'mise run setup-vault' first"
    exit 1
fi

VAULT_PATH=$(cat "$VAULT_PATH_FILE")

# Validate vault path still exists
if [ ! -d "$VAULT_PATH/.obsidian" ]; then
    echo "❌ Obsidian vault not found at: $VAULT_PATH"
    exit 1
fi

PLUGIN_DIR="$VAULT_PATH/.obsidian/plugins/obsidian-kanban-bases"

# Create plugin directory if it doesn't exist
mkdir -p "$PLUGIN_DIR"

# Create symlinks (force overwrite if they exist)
ln -sf "$PROJECT_DIR/dist" "$PLUGIN_DIR/dist"
ln -sf "$PROJECT_DIR/dist/main.js" "$PLUGIN_DIR/main.js"

# Copy manifest.json (non-symlinked, as it shouldn't change)
cp "$PROJECT_DIR/manifest.json" "$PLUGIN_DIR/"

echo "✅ Symlinked plugin to: $PLUGIN_DIR"
